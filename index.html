<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Keep all the previous CSS styles -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@300;500&display=swap');
    :root {
      --neon-blue: #00f7ff;
      --deep-space: #0a0f1c;
      --cyber-purple: #6c00ff;
    }
    
    body {
      background-color: var(--deep-space);
      color: var(--neon-blue);
      font-family: 'Orbitron', 'Roboto Mono', monospace;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }

    h1, h2 {
      color: var(--neon-blue);
      text-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue);
      margin: 0 0 1.5rem;
    }

    .section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: linear-gradient(145deg, #111827dd, #0d1522dd);
      border: 1px solid var(--neon-blue);
      border-radius: 1rem;
      box-shadow: 0 0 1rem var(--neon-blue)33;
      backdrop-filter: blur(5px);
      transition: transform 0.3s ease;
    }

    .section:hover {
      transform: translateY(-2px);
    }

    .input-group {
      margin: 1.5rem 0;
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 700;
      font-size: 0.9rem;
      color: #7fd4f3;
    }

    input[type="number"], 
    input[type="file"], 
    input[type="text"] {
      width: 100%;
      padding: 0.8rem;
      background: #0a0f1c99;
      color: var(--neon-blue);
      border: 1px solid var(--neon-blue)33;
      border-radius: 0.5rem;
      font-family: 'Roboto Mono', monospace;
      transition: all 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--neon-blue);
      box-shadow: 0 0 0.8rem var(--neon-blue)55;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1.5rem 0;
    }

    button {
      background: linear-gradient(45deg, var(--neon-blue), var(--cyber-purple));
      color: var(--deep-space);
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, #ffffff44, transparent);
      transform: rotate(45deg);
      transition: all 0.5s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 1.5rem var(--neon-blue)55;
    }

    button:hover::before {
      animation: shine 1.5s;
    }

    .entry {
      margin: 1.5rem 0;
      padding: 1.2rem;
      background: #0d1b2a99;
      border: 1px solid var(--neon-blue)22;
      border-radius: 0.8rem;
      position: relative;
    }

    .entry::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 0.8rem;
      pointer-events: none;
      box-shadow: inset 0 0 1rem var(--neon-blue)22;
    }

    @keyframes shine {
      0% { left: -50%; }
      100% { left: 150%; }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000000dd;
      display: none;
      place-items: center;
      z-index: 999;
    }

    .spinner {
      border: 4px solid var(--neon-blue)33;
      border-top: 4px solid var(--neon-blue);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 1rem 2rem;
      background: var(--deep-space);
      border: 1px solid var(--neon-blue);
      border-radius: 0.5rem;
      opacity: 0;
      transform: translateY(100%);
      transition: all 0.3s ease;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loader">
    <div class="spinner"></div>
  </div>

  <div class="toast" id="toast"></div>

  <h1>‚ö° CyberTune Pro - Ultimate Handling.meta Editor</h1>

  <div class="section">
    <h2>üìÅ File Operations</h2>
    <div class="button-group">
      <input type="file" id="fileInput" multiple accept=".xml,.meta" hidden />
      <button onclick="document.getElementById('fileInput').click()">
        üì• Import Files
      </button>
      <button onclick="exportCombinedXML()" id="exportBtn" disabled>
        üì§ Export handling.meta
      </button>
      <button onclick="clearAll()">‚ùå Clear All</button>
    </div>
    <div class="note">Supports file drag & drop</div>
    <div id="fileList" class="output"></div>
  </div>

  <div class="section">
    <h2>üîß Active Tuning Parameters</h2>
    <div id="combinedOutput" class="grid"></div>
  </div>

<script>
// Fixed JavaScript implementation
let handlingEntries = new Map();
const toast = document.getElementById('toast');
const loader = document.getElementById('loader');
const exportBtn = document.getElementById('exportBtn');

// Add event listeners
document.getElementById('fileInput').addEventListener('change', parseMultiple);

function showToast(message, duration = 3000) {
  toast.textContent = message;
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), duration);
}

async function parseMultiple() {
  try {
    loader.style.display = 'grid';
    const files = document.getElementById('fileInput').files;
    if (!files.length) return;
    
    handlingEntries.clear();
    const output = document.getElementById('combinedOutput');
    output.innerHTML = '';

    // Fixed Promise.all syntax
    await Promise.all(Array.from(files).map(async file => {
      const text = await file.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, 'text/xml');
      
      if (xml.querySelector('parsererror')) {
        showToast(`‚ùå Error parsing ${file.name}`, 5000);
        return;
      }

      xml.querySelectorAll('Item[type="CHandlingData"]').forEach(item => {
        const handlingName = item.querySelector('handlingName')?.textContent;
        if (!handlingName) return;

        // Clone the original node to preserve structure
        handlingEntries.set(handlingName, item.cloneNode(true));
      });
    }));

    updateUI();
    exportBtn.disabled = false;
    showToast(`‚úÖ Loaded ${handlingEntries.size} handling entries`);
  } catch (error) {
    showToast(`‚ö†Ô∏è Error: ${error.message}`, 5000);
  } finally {
    loader.style.display = 'none';
  }
}

function updateUI() {
  const output = document.getElementById('combinedOutput');
  output.innerHTML = '';

  handlingEntries.forEach((item, handlingName) => {
    const container = document.createElement('div');
    container.className = 'entry';
    container.innerHTML = `<h3>${handlingName}</h3>`;

    Array.from(item.children).forEach(node => {
      if (node.nodeType === 1 && node.hasAttribute('value')) {
        const input = document.createElement('input');
        input.type = 'number';
        input.step = '0.001';
        input.value = node.getAttribute('value');
        input.className = 'param-input';
        input.dataset.param = node.tagName;
        input.dataset.handling = handlingName;

        const label = document.createElement('label');
        label.textContent = node.tagName;
        label.appendChild(input);
        container.appendChild(label);
      }
    });

    output.appendChild(container);
  });
}

async function exportCombinedXML() {
  try {
    loader.style.display = 'grid';
    const entries = Array.from(handlingEntries.values());
    
    // Create fresh XML structure
    const xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<CHandlingDataMgr>
  <HandlingData>
    ${entries.map(entry => {
      const clone = entry.cloneNode(true);
      const handlingName = clone.querySelector('handlingName').textContent;
      
      // Find all inputs for this handling entry
      document.querySelectorAll(`input[data-handling="${handlingName}"]`).forEach(input => {
        const param = input.dataset.param;
        const value = input.value;
        const elem = clone.querySelector(param);
        if (elem) elem.setAttribute('value', value);
      });
      
      return clone.outerHTML;
    }).join('\n    ')}
  </HandlingData>
</CHandlingDataMgr>`;

    // Create downloadable file
    const blob = new Blob([xmlContent], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `handling_${Date.now()}.meta`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('‚úÖ File exported successfully!');
  } catch (error) {
    showToast(`‚ö†Ô∏è Export failed: ${error.message}`, 5000);
  } finally {
    loader.style.display = 'none';
  }
}

function clearAll() {
  handlingEntries.clear();
  document.getElementById('combinedOutput').innerHTML = '';
  document.getElementById('fileInput').value = '';
  exportBtn.disabled = true;
  showToast('üßπ All entries cleared');
}

// Drag & drop handlers
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  document.getElementById('fileInput').files = e.dataTransfer.files;
  parseMultiple();
});

// Real-time input validation
document.addEventListener('input', e => {
  if (e.target.classList.contains('param-input')) {
    const value = parseFloat(e.target.value);
    e.target.style.borderColor = isNaN(value) ? '#ff4444' : '#00f7ff33';
  }
});
</script>
</body>
</html>
